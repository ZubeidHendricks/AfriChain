# Story 3.1: LLM Authenticity Analysis Agent

## Status
Done

## Story
**As a** QA team member,
**I want** automated authenticity scoring,
**so that** I can identify potentially counterfeit products.

## Acceptance Criteria
1. LLM agent analyzes product metadata against known authentic products
2. Authenticity score (0-100) generated with reasoning
3. Analysis includes comparison with similar verified items
4. Explanation provided for scoring decision

## Tasks / Subtasks
- [x] Task 1: Implement LLM authenticity analysis agent (AC: 1)
  - [x] Create `AuthenticityAnalyzer` class in `src/counterfeit_detection/agents/authenticity_analyzer.py`
  - [x] Extend `BaseAgent` from multi-agent framework (Story 1.2 dependency)
  - [x] Integrate OpenAI GPT-4 as primary LLM with Anthropic Claude as fallback
  - [x] Implement async agent registration and communication via Redis
- [x] Task 2: Implement comprehensive scoring system (AC: 2)
  - [x] Create scoring rubric with weighted factors: description (40%), images (30%), price (20%), supplier (10%)
  - [x] Implement LLM prompt engineering for structured scoring output
  - [x] Extract confidence metrics and reasoning from LLM responses
  - [x] Store results in `analysis_results` table with performance metrics
- [x] Task 3: Implement product comparison and vector search (AC: 3)
  - [x] Integrate with vector embeddings from Story 2.2 for similarity search
  - [x] Retrieve top 10 similar products using TiDB vector similarity
  - [x] Compare product attributes: description patterns, price ranges, supplier reputation
  - [x] Implement red flag detection: keyword patterns, price anomalies, supplier blacklists
- [x] Task 4: Create explanation generation and storage (AC: 4)
  - [x] Generate structured explanations using LLM reasoning
  - [x] Format explanations for QA team dashboard consumption
  - [x] Store analysis results with reasoning in database
  - [x] Implement analysis result API endpoints for dashboard integration

## Dev Notes
This story implements the core AI-powered authenticity detection agent following the established architecture.

**Agent Architecture** [Source: docs/architecture/project-structure.md]:
- **Base Class**: `src/counterfeit_detection/agents/base.py` - `BaseAgent` abstract class
- **Implementation**: `src/counterfeit_detection/agents/authenticity_analyzer.py`
- **Communication**: Redis-based message passing for agent coordination
- **Registration**: Agent registry system for discovery and health monitoring

**LLM Integration** [Source: docs/architecture/tech-stack.md]:
```python
# Primary and fallback LLM configuration
PRIMARY_LLM = "gpt-4"  # OpenAI GPT-4 for authenticity analysis
BACKUP_LLM = "claude-3-opus"  # Anthropic Claude for fallback/comparison
EMBEDDING_MODEL = "text-embedding-3-small"  # OpenAI embeddings
```

**Database Integration** [Source: docs/architecture/database-schema.md]:
```sql
-- Analysis results storage
CREATE TABLE authenticity_analyses (
    id VARCHAR(36) PRIMARY KEY,
    product_id VARCHAR(36) NOT NULL,
    agent_id VARCHAR(100) NOT NULL,
    authenticity_score DECIMAL(5,2) NOT NULL,  -- 0.00-100.00
    confidence_score DECIMAL(3,2) NOT NULL,    -- 0.00-1.00
    reasoning TEXT,
    comparison_products JSON,
    analysis_duration_ms INT,
    llm_model VARCHAR(50),
    llm_tokens_used INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Performance Requirements** [Source: docs/5-success-metrics.md]:
- **Target Detection Rate**: 85%+ authenticity detection
- **False Positive Rate**: <5% target
- **Analysis Speed**: <3 seconds per product
- **Agent Uptime**: 99%+ availability

**Scoring Algorithm Design**:
```python
# Weighted scoring components
SCORING_WEIGHTS = {
    "description_analysis": 0.40,  # LLM analysis of product description
    "image_analysis": 0.30,        # Visual similarity and quality assessment  
    "price_analysis": 0.20,        # Price point validation against market
    "supplier_reputation": 0.10    # Supplier history and reputation score
}

# Score calculation: weighted average with confidence adjustment
final_score = (weighted_scores * confidence_multiplier)
```

**LLM Prompt Engineering**:
```python
# Structured prompt template for consistent analysis
ANALYSIS_PROMPT = """
Analyze this product for authenticity indicators:

Product Details:
- Description: {description}
- Category: {category}
- Price: ${price}
- Brand: {brand}
- Supplier: {supplier_name} (reputation: {supplier_reputation})

Similar Authentic Products:
{comparison_products}

Provide analysis in JSON format:
{
  "authenticity_score": <0-100>,
  "confidence": <0.0-1.0>,
  "reasoning": "<detailed explanation>",
  "red_flags": ["<list of concerns>"],
  "positive_indicators": ["<list of authentic signals>"]
}
"""
```

**Vector Search Integration**:
- Uses product embeddings from Story 2.2 for similarity matching
- TiDB vector similarity search with cosine distance
- Retrieves top 10 similar products for comparison baseline
- Filters by category and price range for relevant comparisons

**Agent Communication Flow**:
1. **Trigger**: Product ingestion or manual analysis request
2. **Data Gathering**: Retrieve product details, embeddings, similar products
3. **LLM Analysis**: Send structured prompt to OpenAI GPT-4
4. **Score Calculation**: Apply weighted algorithm with confidence adjustment
5. **Result Storage**: Save to database with performance metrics
6. **Notification**: Queue alerts if score below threshold (Story 4.1)

**Error Handling and Resilience**:
- LLM API failure fallback to Anthropic Claude
- Rate limiting compliance with exponential backoff
- Partial analysis capability if vector search unavailable
- Comprehensive logging for debugging and monitoring

**Integration Points**:
- **Input**: Product data from Story 2.1 ingestion
- **Dependencies**: Vector embeddings from Story 2.2
- **Output**: Triggers rules engine from Story 3.2
- **Alerts**: Feeds notification system from Story 4.1
- **Dashboard**: Provides data for Story 5.1 admin interface

### Testing
- **Unit tests**: Scoring algorithm, prompt template validation, agent lifecycle
- **Integration tests**: LLM API calls, database operations, Redis communication
- **Performance tests**: Analysis speed (<3s), concurrent processing, memory usage
- **Accuracy tests**: Known authentic/counterfeit datasets, A/B prompt testing
- **Reliability tests**: LLM failure scenarios, network timeout handling

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section was populated by the development agent during implementation*

### Agent Model Used
Claude 3.5 Sonnet (BMad Development Agent - James)

### Debug Log References
- All Python modules compile without syntax errors
- AuthenticityAnalyzer agent integrates OpenAI GPT-4 with Anthropic Claude fallback
- Comprehensive scoring system with weighted components and confidence adjustment
- Vector similarity search integration for product comparison
- Analysis results stored in database with structured reasoning and explanations
- Complete API endpoints for analysis management and statistics

### Completion Notes List
- Implemented comprehensive AuthenticityAnalyzer agent extending BaseAgent framework
- Created weighted scoring algorithm with description (40%), image (30%), price (20%), supplier (10%) components
- Integrated OpenAI GPT-4 as primary LLM with structured JSON prompt engineering
- Added Anthropic Claude fallback for resilience and error handling
- Implemented vector similarity search integration for product comparison using Story 2.2 embeddings
- Created AnalysisRepository for comprehensive analysis result storage and retrieval
- Built complete analysis API endpoints with async processing and background tasks
- Added comprehensive test suite for agent functionality and LLM integration
- Implemented red flag detection for suspicious keywords, pricing anomalies, and supplier patterns
- Created structured explanation generation with reasoning, confidence scores, and component breakdowns
- Added analysis statistics and agent performance monitoring capabilities

### File List
- src/counterfeit_detection/agents/authenticity_analyzer.py - Complete LLM-powered authenticity analysis agent
- src/counterfeit_detection/db/repositories/analysis_repository.py - Analysis result storage and retrieval
- src/counterfeit_detection/api/v1/endpoints/analysis.py - Analysis API endpoints with async processing
- src/counterfeit_detection/api/v1/schemas/analysis.py - Pydantic schemas for analysis API
- tests/agents/test_authenticity_analyzer.py - Comprehensive agent testing suite
- Updated: src/counterfeit_detection/api/v1/__init__.py - Added analysis router
- Updated: src/counterfeit_detection/models/database.py - Used existing AnalysisResult model

## QA Results
*Results from QA Agent review will be populated here*