# Story 3.2: Rule-Based Detection Triggers

## Status
Done

## Story
**As an** admin,
**I want** configurable detection rules,
**so that** I can customize authenticity thresholds.

## Acceptance Criteria
1. Threshold-based flagging system (configurable 0-100 score)
2. Rule engine supports custom detection patterns
3. Multiple trigger conditions can be combined
4. Rules can be updated without system restart

## Tasks / Subtasks
- [x] Task 1: Implement threshold-based flagging system (AC: 1)
  - [x] Create `RuleEngine` agent in `src/counterfeit_detection/agents/rule_engine.py`
  - [x] Implement configurable thresholds in `detection_rules` table
  - [x] Support category-specific thresholds (luxury_goods: 80, electronics: 70)
  - [x] Create threshold evaluation logic with score comparison
- [x] Task 2: Create comprehensive rule engine framework (AC: 2)
  - [x] Implement rule definition schema using Pydantic models
  - [x] Create rule evaluation engine with pattern matching
  - [x] Support rule types: threshold, keyword, supplier, price_anomaly, brand_verification
  - [x] Implement rule storage and retrieval from `detection_rules` table
- [x] Task 3: Implement rule combination and precedence logic (AC: 3)
  - [x] Create rule priority system (1-1000 scale, higher = more priority)
  - [x] Implement AND/OR/NOT/XOR logic for compound conditions
  - [x] Add rule conflict resolution based on priority and specificity
  - [x] Support rule chaining and cascading effects
- [x] Task 4: Create dynamic rule management system (AC: 4)
  - [x] Implement `/api/v1/rules` CRUD endpoints per API specifications
  - [x] Create hot-reload capability without service restart
  - [x] Add rule validation and testing simulation mode
  - [x] Implement rule effectiveness tracking and analytics

## Dev Notes
This story implements the configurable rule engine that works alongside LLM analysis for comprehensive authenticity detection.

**Rule Engine Architecture** [Source: docs/architecture/project-structure.md]:
- **Rule Engine Agent**: `src/counterfeit_detection/agents/rule_engine.py` (extends BaseAgent)
- **Rule Service**: `src/counterfeit_detection/services/rule_service.py`
- **Rule Repository**: `src/counterfeit_detection/db/repositories/rule_repository.py`
- **Rule Management API**: `src/counterfeit_detection/api/v1/endpoints/rules.py`

**Database Schema** [Source: docs/architecture/database-schema.md]:
```sql
CREATE TABLE detection_rules (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    rule_type ENUM('threshold', 'keyword', 'supplier', 'price_anomaly', 'brand_verification'),
    config JSON NOT NULL,  -- Rule-specific configuration
    priority INT DEFAULT 100,  -- Higher = higher priority
    active BOOLEAN DEFAULT TRUE,
    category VARCHAR(100),  -- Apply to specific categories
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**Rule Configuration Examples**:
```python
# Threshold rule configuration
{
    "rule_type": "threshold",
    "config": {
        "score_threshold": 30,
        "action": "flag",
        "category": "luxury_goods"
    }
}

# Keyword rule configuration  
{
    "rule_type": "keyword",
    "config": {
        "patterns": ["replica", "fake", "knockoff", "copy"],
        "case_sensitive": false,
        "action": "remove",
        "match_type": "any"
    }
}

# Supplier rule configuration
{
    "rule_type": "supplier", 
    "config": {
        "blacklist": ["supplier-uuid-123"],
        "reputation_threshold": 0.3,
        "action": "flag"
    }
}
```

**API Endpoint Specifications** [Source: docs/architecture/api-specifications.md]:
```http
# List and manage detection rules
GET /api/v1/rules?rule_type=threshold&active=true&category=luxury_goods
POST /api/v1/rules
PUT /api/v1/rules/{rule_id}
DELETE /api/v1/rules/{rule_id}

# Test rule against specific product
POST /api/v1/rules/{rule_id}/test
{
    "product_id": "uuid",
    "simulation_mode": true
}
```

**Rule Types Implementation**:
1. **Threshold Rules**: Compare authenticity scores against configurable thresholds
2. **Keyword Rules**: Pattern matching in product descriptions (regex support)
3. **Supplier Rules**: Blacklist/whitelist and reputation-based filtering
4. **Price Anomaly Rules**: Statistical price deviation detection
5. **Brand Verification Rules**: Verified brand catalog comparison

**Performance Optimization**:
- **Rule Caching**: Cache active rules in Redis for fast evaluation
- **Early Termination**: Stop evaluation on high-priority matches
- **Batch Evaluation**: Process multiple products simultaneously
- **Index Strategy**: Database indexes on rule_type, category, active status

**Integration Workflow**:
1. **Trigger**: Authenticity analysis completion from Story 3.1
2. **Rule Loading**: Load applicable rules based on product category
3. **Evaluation**: Run rule engine against product and analysis data
4. **Action Execution**: Queue enforcement actions based on rule matches
5. **Logging**: Record rule matches for analytics and debugging

**Integration Points**:
- **Input**: Analysis results from Story 3.1 LLM agent
- **Dependencies**: Product data from Story 2.1, vector search from Story 2.2
- **Output**: Triggers enforcement actions (Story 4.2) and notifications (Story 4.1)
- **Monitoring**: Feeds rule effectiveness data to analytics (Story 5.2)

### Testing
- **Unit tests**: Rule evaluation logic, configuration validation, priority handling
- **Integration tests**: Database operations, API endpoints, agent communication
- **Performance tests**: Rule evaluation speed <100ms, concurrent processing
- **Business logic tests**: Rule combination scenarios, conflict resolution
- **End-to-end tests**: Complete product analysis → rule evaluation → action workflow

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section was populated by the development agent during implementation*

### Agent Model Used
Claude 3.5 Sonnet (BMad Development Agent - James)

### Debug Log References
- All Python modules compile without syntax errors
- RuleEngine agent implements comprehensive rule evaluation with caching and Redis communication
- Complete rule evaluation system with threshold, keyword, supplier, price anomaly, and brand verification rules
- Advanced rule combination logic with AND/OR/NOT/XOR operators and conflict resolution
- Rule service implements precedence logic, cascading effects, and sophisticated conflict resolution strategies
- Hot-reload capability implemented through cache refresh endpoints and background tasks
- Complete API endpoints for rule CRUD operations with validation and testing capabilities

### Completion Notes List
- Implemented comprehensive RuleEngine agent extending BaseAgent framework with Redis-based communication
- Created configurable threshold-based flagging system supporting category-specific thresholds and score comparison
- Built rule evaluation framework supporting 5 rule types: threshold, keyword, supplier, price anomaly, and brand verification
- Implemented advanced rule combination logic with AND/OR/NOT/XOR operators and priority-based conflict resolution
- Created RuleService for sophisticated rule precedence, cascading effects, and conflict resolution strategies
- Built complete rule repository with CRUD operations, validation, bulk creation, and statistics
- Implemented comprehensive rule management API with 15+ endpoints for creation, updating, testing, and evaluation
- Added hot-reload capability through cache refresh mechanisms and background task processing
- Created extensive test suite covering all rule evaluators, combination logic, and API functionality
- Implemented rule effectiveness tracking, analytics, and performance monitoring
- Added support for rule chaining, cascading effects, and complex rule dependency management
- Built rule validation system with type-specific configuration validation and error reporting

### File List
- src/counterfeit_detection/agents/rule_engine.py - Complete rule engine agent with caching and evaluation logic
- src/counterfeit_detection/db/repositories/rule_repository.py - Rule repository with CRUD operations and statistics
- src/counterfeit_detection/api/v1/schemas/rules.py - Comprehensive Pydantic schemas for rule API
- src/counterfeit_detection/api/v1/endpoints/rules.py - Complete rule management API endpoints
- src/counterfeit_detection/services/rule_service.py - Advanced rule combination and precedence service
- tests/agents/test_rule_engine.py - Comprehensive test suite for rule engine functionality
- Updated: src/counterfeit_detection/api/v1/__init__.py - Added rules router to API configuration

## QA Results
*Results from QA Agent review will be populated here*