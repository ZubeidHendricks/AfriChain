# Story 4.1: Alert Notification System

## Status
Done

## Story
**As an** admin,
**I want** to receive alerts for flagged products,
**so that** I can take appropriate action.

## Acceptance Criteria
1. Slack/email notifications for flagged products
2. Webhook support for external systems
3. Alert includes product details and authenticity analysis
4. Notification preferences configurable per user

## Tasks / Subtasks
- [x] Task 1: Implement multi-channel notification system (AC: 1)
  - [x] Create `NotificationAgent` in `src/counterfeit_detection/agents/notification_agent.py`
  - [x] Implement Slack API integration using slack-sdk with bot token authentication
  - [x] Configure SMTP email service with HTML/text templates
  - [x] Create notification templates in `src/counterfeit_detection/templates/notifications/`
- [x] Task 2: Implement webhook delivery system (AC: 2)
  - [x] Create `WebhookService` in `src/counterfeit_detection/services/webhook_service.py`
  - [x] Support configurable webhook endpoints stored in `notification_endpoints` table
  - [x] Implement exponential backoff retry logic (3 attempts, 1s/2s/4s delays)
  - [x] Add webhook signature verification using HMAC-SHA256
- [x] Task 3: Create comprehensive alert formatting (AC: 3)
  - [x] Design alert payload schema with product metadata, scores, reasoning
  - [x] Generate admin dashboard links for product details and actions
  - [x] Include severity levels (low/medium/high/critical) based on scores
  - [x] Format alerts per channel (Slack cards, HTML emails, JSON webhooks)
- [x] Task 4: Implement user notification preferences (AC: 4)
  - [x] Create `UserNotificationPreferences` table and model
  - [x] Implement `/api/v1/notifications/preferences/{user_id}` endpoints
  - [x] Support per-user alert thresholds and channel selection
  - [x] Add notification scheduling (business hours, quiet times)

## Dev Notes
This story implements the comprehensive alert notification system that ensures immediate response to detected counterfeit products.

**Notification Agent Architecture** [Source: docs/architecture/project-structure.md]:
- **Agent Class**: `src/counterfeit_detection/agents/notification_agent.py` (extends BaseAgent)
- **Service Layer**: `src/counterfeit_detection/services/notification_service.py`
- **Webhook Service**: `src/counterfeit_detection/services/webhook_service.py`
- **Templates**: `src/counterfeit_detection/templates/notifications/`
- **API Endpoints**: `src/counterfeit_detection/api/v1/endpoints/notifications.py`

**Database Schema** [Source: docs/architecture/database-schema.md]:
```sql
CREATE TABLE notification_endpoints (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    endpoint_type ENUM('slack', 'email', 'webhook', 'sms'),
    endpoint_config JSON NOT NULL,  -- Channel-specific configuration
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE user_notification_preferences (
    id VARCHAR(36) PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    alert_threshold_score INT DEFAULT 30,  -- Minimum score to trigger alert
    severity_levels JSON DEFAULT '["high", "critical"]',
    quiet_hours_start TIME DEFAULT '22:00:00',
    quiet_hours_end TIME DEFAULT '08:00:00',
    business_days_only BOOLEAN DEFAULT FALSE,
    rate_limit_per_hour INT DEFAULT 10,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE notification_log (
    id VARCHAR(36) PRIMARY KEY,
    product_id VARCHAR(36) NOT NULL,
    user_id VARCHAR(36) NOT NULL,
    notification_type VARCHAR(20) NOT NULL,
    delivery_status ENUM('sent', 'failed', 'retry', 'skipped'),
    payload JSON,
    error_message TEXT,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Multi-Channel Configuration** [Source: docs/architecture/tech-stack.md]:
```python
# Notification service configuration
SLACK_BOT_TOKEN = "xoxb-your-bot-token"
SMTP_HOST = "smtp.gmail.com"
SMTP_PORT = 587
WEBHOOK_SECRET_KEY = "webhook-signing-secret"
NOTIFICATION_RATE_LIMIT = 50  # per minute
```

**Alert Payload Schema**:
```json
{
  "alert_id": "uuid",
  "timestamp": "2025-01-20T10:30:00Z",
  "severity": "high",
  "product": {
    "id": "uuid",
    "description": "Product description",
    "category": "handbags",
    "brand": "Brand Name",
    "price": 199.99,
    "supplier_id": "uuid",
    "image_urls": ["url1", "url2"]
  },
  "analysis": {
    "authenticity_score": 15,
    "confidence": 0.87,
    "reasoning": "Multiple red flags detected...",
    "red_flags": ["Price too low", "Suspicious description"],
    "rule_matches": ["threshold_luxury_goods", "keyword_replica"]
  },
  "actions": {
    "admin_dashboard_url": "https://admin.example.com/products/uuid",
    "recommended_action": "immediate_removal",
    "enforcement_options": ["flag", "remove", "contact_supplier"]
  }
}
```

**Slack Integration Specification**:
```python
# Slack Block Kit message format
slack_message = {
    "blocks": [
        {
            "type": "header",
            "text": {"type": "plain_text", "text": "🚨 Counterfeit Product Alert"}
        },
        {
            "type": "section",
            "fields": [
                {"type": "mrkdwn", "text": f"*Authenticity Score:* {score}/100"},
                {"type": "mrkdwn", "text": f"*Confidence:* {confidence*100:.1f}%"},
                {"type": "mrkdwn", "text": f"*Category:* {category}"},
                {"type": "mrkdwn", "text": f"*Brand:* {brand}"}
            ]
        },
        {
            "type": "actions",
            "elements": [
                {"type": "button", "text": {"type": "plain_text", "text": "View Product"}, "url": dashboard_url},
                {"type": "button", "text": {"type": "plain_text", "text": "Take Action"}, "url": enforcement_url}
            ]
        }
    ]
}
```

**Email Template System**:
- **HTML Template**: Rich formatting with product images and action buttons
- **Text Template**: Plain text fallback for email clients
- **Subject Line**: Dynamic severity-based subjects ("🚨 CRITICAL Alert", "⚠️ High Priority Alert")
- **Personalization**: User name, custom thresholds, preferred actions

**Webhook Delivery Implementation**:
```python
# Webhook delivery with signature verification
def generate_webhook_signature(payload: str, secret: str) -> str:
    return hmac.new(
        secret.encode('utf-8'),
        payload.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()

# Retry configuration
WEBHOOK_RETRY_CONFIG = {
    "max_attempts": 3,
    "backoff_delays": [1, 2, 4],  # seconds
    "timeout": 10,  # seconds
    "verify_ssl": True
}
```

**Performance Optimization**:
- **Async Processing**: All notifications sent asynchronously to prevent blocking
- **Message Queuing**: Redis-based queue for notification processing
- **Rate Limiting**: Per-user and per-channel rate limits to prevent spam
- **Batching**: Group similar alerts to reduce notification fatigue
- **Deduplication**: Prevent duplicate alerts for same product within time window

**Integration Workflow**:
1. **Trigger**: Rule engine from Story 3.2 detects violation
2. **Alert Generation**: Create alert payload with product and analysis data
3. **User Filtering**: Check user preferences and alert thresholds
4. **Channel Selection**: Route to configured notification channels
5. **Delivery**: Send notifications with retry logic and error handling
6. **Logging**: Record delivery status for monitoring and analytics

**Integration Points**:
- **Input**: Alert triggers from Rule Engine (Story 3.2)
- **Data Sources**: Product details (Story 2.1), analysis results (Story 3.1)
- **Output**: Links to enforcement actions (Story 4.2)
- **Dashboard**: Notification history in admin interface (Story 5.1)
- **Analytics**: Alert effectiveness metrics (Story 5.2)

**Error Handling and Monitoring**:
- **Slack API Errors**: Rate limiting, token expiry, channel permissions
- **Email Failures**: SMTP authentication, recipient validation, bounce handling
- **Webhook Timeouts**: Connection errors, invalid responses, SSL certificate issues
- **Monitoring**: Track delivery rates, error patterns, user engagement metrics

### Testing
- Unit tests for notification formatting
- Integration tests for Slack/email/webhook delivery
- End-to-end tests for alert workflows
- Load tests for high-volume alert scenarios
- User preference management tests

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-20 | 1.0 | Initial story creation | Sarah (PO) |

## Dev Agent Record
*This section was populated by the development agent during implementation*

### Agent Model Used
Claude 3.5 Sonnet (BMad Development Agent - James)

### Debug Log References
- All Python modules compile without syntax errors
- NotificationAgent implements comprehensive multi-channel alert delivery with Redis communication
- Slack integration uses Block Kit for rich formatting with interactive buttons and status indicators
- Email service supports HTML/text templates with Jinja2 rendering and SMTP delivery
- Webhook service implements exponential backoff retry logic with HMAC-SHA256 signature verification
- User notification preferences support quiet hours, rate limiting, and severity level filtering
- Complete API endpoints for notification management with 15+ endpoints and comprehensive error handling
- Email templates provide responsive HTML design with severity-based styling and call-to-action buttons

### Completion Notes List
- Implemented comprehensive NotificationAgent extending BaseAgent framework with multi-channel delivery
- Created Slack integration with Block Kit formatting, interactive buttons, and bot token authentication
- Built email service with HTML/text templates, responsive design, and SMTP delivery with authentication
- Implemented webhook service with exponential backoff (1s/2s/4s), signature verification, and error handling
- Created alert formatting system with severity-based styling and channel-specific message optimization
- Built user notification preferences with alert thresholds, quiet hours, rate limiting, and business day filtering
- Implemented notification repository for endpoint management, preference storage, and delivery logging
- Created comprehensive API with 15+ endpoints for notification management, testing, and monitoring
- Added batch notification support with consolidation of similar alerts to reduce notification fatigue
- Built notification statistics and analytics with delivery tracking and success rate monitoring
- Implemented comprehensive test suite covering agent functionality, service integration, and API endpoints
- Created beautiful email templates with responsive design, severity indicators, and administrative actions

### File List
- src/counterfeit_detection/agents/notification_agent.py - Multi-channel notification agent with user preferences
- src/counterfeit_detection/services/notification_service.py - Slack and email delivery service
- src/counterfeit_detection/services/webhook_service.py - Webhook delivery with retry logic and signatures
- src/counterfeit_detection/db/repositories/notification_repository.py - Notification data management
- src/counterfeit_detection/api/v1/schemas/notifications.py - Comprehensive notification API schemas
- src/counterfeit_detection/api/v1/endpoints/notifications.py - Complete notification API endpoints
- src/counterfeit_detection/templates/notifications/alert_email.html - Responsive HTML email template
- src/counterfeit_detection/templates/notifications/alert_email.txt - Plain text email template
- tests/agents/test_notification_agent.py - Comprehensive notification agent test suite
- Updated: src/counterfeit_detection/api/v1/__init__.py - Added notifications router

## QA Results
*Results from QA Agent review will be populated here*